<link rel="import" href="vaadin-grid-templatizer.html">

<dom-module id="vaadin-grid-row-details-styles">
  <template>
    <style>
      [detailscell] {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
      }
    </style>
  </template>
</dom-module>
<dom-module id="vaadin-grid-row-details-themability-styles">
  <template>
    <style>
      .vaadin-grid-cell[detailscell] ::slotted(vaadin-grid-cell-content) {
        background: #fff;
        @apply(--vaadin-grid-body-row-details-cell);
      }
    </style>
  </template>
</dom-module>


<script>
  window.Vaadin = window.Vaadin || {};
  Vaadin.Grid = Vaadin.Grid || {};

  /**
   * @polymerMixin
   */
  Vaadin.Grid.RowDetailsMixin = superClass => class RowDetailsMixin extends superClass {
    static get properties() {
      return {
        /**
        * An array containing references to expanded items.
        */
        expandedItems: {
          type: Array,
          value: function() {
            return [];
          }
        }
      };
    }

    static get observers() {
      return [
        '_expandedItemsChanged(expandedItems.*, dataProvider)',
        '_rowDetailsTemplateChanged(_rowDetailsTemplate)'
      ];
    }

    ready() {
      super.ready();
      this.addEventListener('template-instance-changed', this._templateInstanceChangedExpanded);
    }

    _expandedItemsChanged(changeRecord, dataProvider) {
      if (changeRecord === undefined || dataProvider === undefined) {
        return;
      }

      if (changeRecord.path === 'expandedItems.length') {
        // Let’s avoid duplicate work of both “.splices” and “.length” updates.
        return;
      }

      this._flushItemsDebouncer();

      // TODO: Make this work again and render the details row somehow.
      // if (this._physicalItems) {
      //   this._physicalItems.forEach(function(row) {
      //     row.expanded = this._isExpanded(row.item);
      //   }, this);
      // }
    }

    _rowDetailsTemplateChanged(rowDetailsTemplate) {
      var templatizer = new vaadin.elements.grid.Templatizer();
      templatizer.dataHost = this.dataHost;
      templatizer._instanceProps = {
        expanded: true,
        index: true,
        item: true,
        selected: true
      };

      // row details templatizer needs to be attached so that `item-changed` and
      // `template-instance-changed` events propagate to grid.
      this.root.appendChild(templatizer);

      templatizer.template = rowDetailsTemplate;
      rowDetailsTemplate.templatizer = templatizer;
    }

    _isExpanded(item) {
      return this.expandedItems && this.expandedItems.indexOf(item) !== -1;
    }

    /**
     * Expand the details row of a given item.
     */
    expandItem(item) {
      if (!this._isExpanded(item)) {
        this.push('expandedItems', item);
      }
    }

    /**
     * Collapse the details row of a given item.
     */
    collapseItem(item) {
      if (this._isExpanded(item)) {
        this.splice('expandedItems', this.expandedItems.indexOf(item), 1);
      }
    }

    _expandedInstanceChangedCallback(instance, value) {
      if (super._expandedInstanceChangedCallback) {
        super._expandedInstanceChangedCallback(instance, value)
      }
      if (value) {
        this.expandItem(instance.item);
      } else {
        this.collapseItem(instance.item);
      }
    }

    _templateInstanceChangedExpanded(e) {
      if (e.detail.prop === 'expanded') {
        if (e.detail.value) {
          this.expandItem(e.detail.inst.item);
        } else {
          this.collapseItem(e.detail.inst.item);
        }

        // stop this internal event from propagating outside.
        e.stopPropagation();
      }
    }
  };
</script>
